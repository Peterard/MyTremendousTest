<!DOCTYPE html>
<html>
  <head>
    <title>Score History Checker</title>
    
    <!-- Include order: first jquery, then opencpu.js, and then your code -->
    <script src="opencpu/jquery-1.10.2.min.js"></script>
    <script src="opencpu/opencpu-0.4.js"></script>
    <script src="CountryToLeagueJson.js"></script>
    <script>
    //init this script when the page has loaded
    $(document).ready(function(){
      function unpackScores(outputMessage){
        var outputMessageArray = outputMessage;
        
        var scoreOutput = "";
        
        for(var i=0; i<outputMessageArray.length;i++){
          var date = outputMessageArray[i]["Date"];
          var division = outputMessageArray[i]["Competition"];
          var homeTeam = outputMessageArray[i]["HomeTeam"];
          var awayTeam = outputMessageArray[i]["AwayTeam"];
          var score = outputMessageArray[i]["Score"];
          var result = outputMessageArray[i]["Result"];
          
          scoreOutput = scoreOutput +'<div class="match-result '+result+'">'+ date + " " + division + " : " + homeTeam + " " + score + " " + awayTeam + "</div>";
          
          
        }
        return scoreOutput;
      }
      
      $("#team-select").on("change", function(){
        //disable the button to prevent multiple clicks
        $("#team-select").attr("disabled", "disabled");
        
        //read the value for 'myname'
        var myname = $("#team-select").val();
        
        //perform the request
        var req = ocpu.rpc("hello", {
          myname : myname
        }, function(output){
          $("#output").empty();
          $("#output").append(unpackScores(output.message));
          console.log(unpackScores(output.message));
          console.log(output.message);
        });
        
        //if R returns an error, alert the error message
        req.fail(function(){
          alert("Server error: " + req.responseText);
        });
        
        //after request complete, re-enable the button 
        req.always(function(){
          $("#team-select").removeAttr("disabled")
        });
      });
      
      var countryOptionsElement = "";
      
      for (var i = 0; i < Object.keys(countryToLeagueJson).length; i++) { 
          var countryName = Object.keys(countryToLeagueJson)[i];
          countryOptionsElement = countryOptionsElement + '<option value="' + countryName + '">' + countryName + '</option>';
      }
      
      $("#country-select").empty();
      $("#country-select").append(countryOptionsElement);
        
      var leagueOptionsElement = "";
        
        var listOfLeagues = countryToLeagueJson[$("#country-select").val()];
        
        for (var i = 0; i < Object.keys(listOfLeagues).length; i++) { 
          var leagueUrl = Object.keys(listOfLeagues)[i];
          var leagueName = Object.keys(listOfLeagues[leagueUrl])[0];
          leagueOptionsElement = leagueOptionsElement + '<option value="' + leagueUrl + '">' + leagueName + '</option>';
      }
        
        $("#league-select").empty();
        $("#league-select").append(leagueOptionsElement);
       
      var teamOptionsElement = "";
        
        var listOfLeagues = countryToLeagueJson[$("#country-select").val()];
        var leagueName = listOfLeagues[$("#league-select").val()];
        var listOfTeams = leagueName[Object.keys(leagueName)[0]];
        
        for (var i = 0; i < Object.keys(listOfTeams).length; i++) { 
          var teamUrl = Object.keys(listOfTeams)[i];
          var teamName = listOfTeams[teamUrl];
          teamOptionsElement = teamOptionsElement + '<option value="' + teamUrl + '">' + teamName + '</option>';
      }
        $("#team-select").empty();
        $("#team-select").append(teamOptionsElement);
          
         
      
      $("#country-select").on("change", function(){
        
        var leagueOptionsElement = "";
        
        var listOfLeagues = countryToLeagueJson[$("#country-select").val()];
        
        for (var i = 0; i < Object.keys(listOfLeagues).length; i++) { 
          var leagueUrl = Object.keys(listOfLeagues)[i];
          var leagueName = Object.keys(listOfLeagues[leagueUrl])[0];
          leagueOptionsElement = leagueOptionsElement + '<option value="' + leagueUrl + '">' + leagueName + '</option>';
      }
        
        $("#league-select").empty();
        $("#league-select").append(leagueOptionsElement);
        
      });
          
          $("#country-select").on("change", function(){
        
        var teamOptionsElement = "";
        
        var listOfLeagues = countryToLeagueJson[$("#country-select").val()];
        var leagueName = listOfLeagues[$("#league-select").val()];
        var listOfTeams = leagueName[Object.keys(leagueName)[0]];
        
        console.log(listOfTeams);
        
        for (var i = 0; i < Object.keys(listOfTeams).length; i++) { 
          var teamUrl = Object.keys(listOfTeams)[i];
          var teamName = listOfTeams[teamUrl];
          teamOptionsElement = teamOptionsElement + '<option value="' + teamUrl + '">' + teamName + '</option>';
      }
        $("#team-select").empty();
        $("#team-select").append(teamOptionsElement);
        
      });
      
      $("#league-select").on("change", function(){
        
        var teamOptionsElement = "";
        
        var listOfLeagues = countryToLeagueJson[$("#country-select").val()];
        var leagueName = listOfLeagues[$("#league-select").val()];
        var listOfTeams = leagueName[Object.keys(leagueName)[0]];
        
        console.log(listOfTeams);
        
        for (var i = 0; i < Object.keys(listOfTeams).length; i++) { 
          var teamUrl = Object.keys(listOfTeams)[i];
          var teamName = listOfTeams[teamUrl];
          teamOptionsElement = teamOptionsElement + '<option value="' + teamUrl + '">' + teamName + '</option>';
      }
        $("#team-select").empty();
        $("#team-select").append(teamOptionsElement);
        
      });
    });
    </script>
    
    <style>
      #output{
        min-height: 200px;
        border: 1px solid gray;
        padding: 3px;
        overflow: auto;
        white-space: pre-line;
      }
      
      .result-win{
      background-color:#97db97;
      }
      .result-loss{
      background-color:#ff7272;
      }
      .result-draw{
      background-color:#d6d6d6;
      }
      .match-result{
      text-align:center;
      }
    </style>
    
  </head>
    
  <body>
    <select id="country-select">
    </select>
    <select id="league-select">
    </select>
    <select id="team-select">
    </select>
    <br />
    <div id="output"></div>
  
    <br />
    
  </body>
</html>
