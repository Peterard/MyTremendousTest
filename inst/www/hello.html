<!DOCTYPE html>
<html>
  <head>
    <title>Hello</title>
    
    <!-- Include order: first jquery, then opencpu.js, and then your code -->
    <script src="opencpu/jquery-1.10.2.min.js"></script>
    <script src="opencpu/opencpu-0.4.js"></script>
    <script src="CountryToLeagueJson.js"></script>
    <script>
    //init this script when the page has loaded
    $(document).ready(function(){
      function unpackScores(outputMessage){
        outputMessageArray = outputMessage[0];
        
        var scoreOutput = "";
        
        for(var i=0; i<outputMessageArray.length;i++){
          var date = outputMessageArray[i]["Date"];
          var division = outputMessageArray[i]["Competition"];
          var homeTeam = outputMessageArray[i]["Outcome"];
          var awayTeam = outputMessageArray[i]["Score/Time"];
          var score = outputMessageArray[i]["Home team"];
          scoreOutput = scoreOutput + date + " " + division + " : " + homeTeam + " " + score + " " + awayTeam + "\n";
        }
        return scoreOutput;
      }
      
      $("#team-select").on("change", function(){
        //disable the button to prevent multiple clicks
        $("#team-select").attr("disabled", "disabled");
        
        //read the value for 'myname'
        var myname = $("#team-select").val();
        
        //perform the request
        var req = ocpu.rpc("hello", {
          myname : myname
        }, function(output){
          $("#Output").text(unpackScores(output.message));
          console.log(output.message);
        });
        
        //if R returns an error, alert the error message
        req.fail(function(){
          alert("Server error: " + req.responseText);
        });
        
        //after request complete, re-enable the button 
        req.always(function(){
          $("#team-select").removeAttr("disabled")
        });
      });
      
      var countryOptionsElement = "";
      
      for (var i = 0; i < Object.keys(countryToLeagueJson).length; i++) { 
          var countryName = Object.keys(countryToLeagueJson)[i];
          countryOptionsElement = countryOptionsElement + '<option value="' + countryName + '">' + countryName + '</option>';
      }
      
      $("#country-select").empty();
      $("#country-select").append(countryOptionsElement);
        
      var leagueOptionsElement = "";
        
        var listOfLeagues = countryToLeagueJson[$("#country-select").val()];
        
        for (var i = 0; i < Object.keys(listOfLeagues).length; i++) { 
          var leagueUrl = Object.keys(listOfLeagues)[i];
          var leagueName = Object.keys(listOfLeagues[leagueUrl])[0];
          leagueOptionsElement = leagueOptionsElement + '<option value="' + leagueUrl + '">' + leagueName + '</option>';
      }
        
        $("#league-select").empty();
        $("#league-select").append(leagueOptionsElement);
       
      var teamOptionsElement = "";
        
        var listOfLeagues = countryToLeagueJson[$("#country-select").val()];
        var leagueName = listOfLeagues[$("#league-select").val()];
        var listOfTeams = leagueName[Object.keys(leagueName)[0]];
        
        for (var i = 0; i < Object.keys(listOfTeams).length; i++) { 
          var teamUrl = Object.keys(listOfTeams)[i];
          var teamName = listOfTeams[teamUrl];
          teamOptionsElement = teamOptionsElement + '<option value="' + teamUrl + '">' + teamName + '</option>';
      }
        $("#team-select").empty();
        $("#team-select").append(teamOptionsElement);
          
         
      
      $("#country-select").on("change", function(){
        
        var leagueOptionsElement = "";
        
        var listOfLeagues = countryToLeagueJson[$("#country-select").val()];
        
        for (var i = 0; i < Object.keys(listOfLeagues).length; i++) { 
          var leagueUrl = Object.keys(listOfLeagues)[i];
          var leagueName = Object.keys(listOfLeagues[leagueUrl])[0];
          leagueOptionsElement = leagueOptionsElement + '<option value="' + leagueUrl + '">' + leagueName + '</option>';
      }
        
        $("#league-select").empty();
        $("#league-select").append(leagueOptionsElement);
        
      });
          
          $("#country-select").on("change", function(){
        
        var teamOptionsElement = "";
        
        var listOfLeagues = countryToLeagueJson[$("#country-select").val()];
        var leagueName = listOfLeagues[$("#league-select").val()];
        var listOfTeams = leagueName[Object.keys(leagueName)[0]];
        
        console.log(listOfTeams);
        
        for (var i = 0; i < Object.keys(listOfTeams).length; i++) { 
          var teamUrl = Object.keys(listOfTeams)[i];
          var teamName = listOfTeams[teamUrl];
          teamOptionsElement = teamOptionsElement + '<option value="' + teamUrl + '">' + teamName + '</option>';
      }
        $("#team-select").empty();
        $("#team-select").append(teamOptionsElement);
        
      });
      
      $("#league-select").on("change", function(){
        
        var teamOptionsElement = "";
        
        var listOfLeagues = countryToLeagueJson[$("#country-select").val()];
        var leagueName = listOfLeagues[$("#league-select").val()];
        var listOfTeams = leagueName[Object.keys(leagueName)[0]];
        
        console.log(listOfTeams);
        
        for (var i = 0; i < Object.keys(listOfTeams).length; i++) { 
          var teamUrl = Object.keys(listOfTeams)[i];
          var teamName = listOfTeams[teamUrl];
          teamOptionsElement = teamOptionsElement + '<option value="' + teamUrl + '">' + teamName + '</option>';
      }
        $("#team-select").empty();
        $("#team-select").append(teamOptionsElement);
        
      });
    });
    </script>
    
    <style>
      #output{
        height: 80px;
        width: 500px;
        border: 1px solid gray;
        padding: 3px;
      }
    </style>
    
  </head>
    
  <body>
    <h1>Hello, world!</h1>
    
    <b>Your name: </b> <input type="text" id="namefield">
    
    <button id="submitbutton" type="button">Submit to server!</button>
    
    <p id="output"></p>
  
    <br />

    <p>
     This is a basic JSON RPC call to OpenCPU. We use <tt>ocpu.rpc</tt> from the <tt>opencpu.js</tt> library to call the R function called <tt>hello</tt> included in this R package. 
    </p>
    <select id="country-select">
    </select>
    <select id="league-select">
    </select>
    <select id="team-select">
    </select>
    
    <p>Have a look at the HTML source code! Some things to notice:</p>
    <ul>
      <li>We can always see the source code of the R function using the API, e.g <a href="../R/hello">here</a>.</li>
      <li>If the R function has a manual page, it we can find it <a href="../man/hello">here</a></li>
      <li>When the name field is empty, the R function raises an error. Notice how we deal with this in javascript.</li>
    </ul>
    
  </body>
</html>
